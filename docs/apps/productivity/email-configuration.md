# Email Account Configuration (macOS Mail.app)

## Overview

**Story**: 02.10-001 - macOS Mail.app Email Account Automation
**Category**: Productivity / Email
**Automation Level**: Semi-Automated (accounts pre-configured, credentials entered manually)
**Installation Method**: Configuration Profile (.mobileconfig)
**License**: Free (macOS built-in Mail.app)

## What Gets Installed

This automation configures **5 email accounts** in macOS Mail.app:

1. **Gmail Account** (OAuth2 authentication)
   - IMAP: imap.gmail.com (port 993, SSL)
   - SMTP: smtp.gmail.com (port 587, STARTTLS)
   - Auth: Password/App-Specific Password (OAuth2 via browser redirect)

2-5. **Gandi.net Accounts** (4 accounts, password authentication)
   - IMAP: mail.gandi.net (port 993, SSL)
   - SMTP: mail.gandi.net (port 587, STARTTLS)
   - Auth: Password (full email address as username)

## How It Works

### During Bootstrap (Phase 2)

1. **Email Address Collection**: Bootstrap prompts for 5 email addresses
2. **Email Validation**: Each address validated with regex pattern (must contain `@` and domain)
3. **Confirmation**: All 5 addresses displayed for confirmation
4. **File Generation**: Creates `email-config.nix` (gitignored, contains your real email addresses)

### During darwin-rebuild

1. **Configuration Profile Generation**: Creates `.mobileconfig` XML file with all 5 accounts
2. **Profile Placement**: Saves profile to `/tmp/email-accounts.mobileconfig`
3. **Manual Installation Required**: You must install the profile via System Preferences > Profiles

### After First Mail.app Launch

1. **Credential Entry**: Mail.app prompts for passwords/OAuth for each account
2. **Account Sync**: Accounts begin syncing mail after credential entry
3. **Ready to Use**: All accounts accessible in Mail.app sidebar

## Post-Install Configuration

### Step 1: Install Configuration Profile

1. Open **System Preferences** (macOS Ventura+) or **System Settings** (macOS Sonoma+)
2. Navigate to **Profiles** (left sidebar, near bottom)
3. Click **"FX Email Accounts"** profile
4. Click **Install** button
5. Enter your macOS password when prompted
6. Click **Install** again to confirm

**Security Note**: Configuration profiles are Apple-supported and safe. This profile only contains email server settings and your email addresses (no passwords).

### Step 2: Launch Mail.app and Enter Credentials

#### Gmail Account Setup

1. **Open Mail.app** for the first time
2. **Find Gmail account** in sidebar (should already be listed)
3. **Click account** → Enter password when prompted
4. **Choose authentication method**:
   - **Option A (Recommended)**: Use App-Specific Password
     - Go to https://myaccount.google.com/apppasswords
     - Sign in to your Google account
     - Generate new app password (select "Mail" and "Mac")
     - Copy 16-character password (no spaces)
     - Paste into Mail.app password prompt
   - **Option B**: Use regular password + OAuth
     - Enter Gmail password
     - Complete 2FA if enabled
     - Authorize Mail.app access via browser redirect
5. **Wait for sync**: Gmail will begin downloading messages (~1-5 minutes)

**Troubleshooting Gmail Auth**:
- If OAuth fails: Use App-Specific Password instead
- If "Less Secure Apps" error: Enable 2FA and use App-Specific Password
- If connection fails: Check firewall/VPN settings

#### Gandi.net Account Setup (4 accounts)

For each of the 4 Gandi.net accounts:

1. **Click account** in Mail.app sidebar
2. **Enter password** when prompted:
   - Username: Your full email address (e.g., `account1@yourdomain.com`)
   - Password: Your Gandi.net mailbox password
3. **Wait for sync**: IMAP sync begins immediately

**Gandi.net Password Notes**:
- Password is your **mailbox password** (not webmail login password)
- If forgotten: Reset via Gandi.net webmail → Settings → Change Password
- Password must be entered for **both IMAP (incoming) and SMTP (outgoing)**
  - Checkbox "Use same password for outgoing" should be checked (enabled by default)

### Step 3: Verify All Accounts Work

**Test Receiving**:
1. Send test email to each account from another device
2. Verify emails appear in Mail.app inbox
3. Check IMAP sync is working (emails sync across devices)

**Test Sending**:
1. Compose new email from each account (use "From:" dropdown)
2. Send to yourself or test address
3. Verify email sends successfully
4. Check "Sent" folder syncs to IMAP server

## Configuration File Structure

### email-config.nix (Gitignored, Private)

**Location**: `/Users/yourusername/Documents/nix-install/email-config.nix`
**Generated by**: Bootstrap Phase 2
**Contents**: Your 5 email addresses (private data)

```nix
{
  gmail = "your-email@gmail.com";
  gandi1 = "account1@yourdomain.com";
  gandi2 = "account2@yourdomain.com";
  gandi3 = "account3@yourdomain.com";
  gandi4 = "account4@yourdomain.com";
}
```

**Security**:
- ✅ **Gitignored**: This file is NOT tracked in version control
- ✅ **Local only**: Never pushed to GitHub
- ⚠️ **Contains real emails**: Treat as sensitive data
- ✅ **No passwords**: Only email addresses stored (passwords entered manually)

### email-config.template.nix (Tracked, Template)

**Location**: `/Users/yourusername/Documents/nix-install/email-config.template.nix`
**Purpose**: Template file with placeholders (tracked in git)
**Usage**: Bootstrap replaces `@EMAIL_GMAIL@` etc. with real values

### darwin/email-accounts.nix (Tracked, Module)

**Location**: `/Users/yourusername/Documents/nix-install/darwin/email-accounts.nix`
**Purpose**: Nix-darwin module that reads email-config.nix and generates .mobileconfig
**Execution**: Runs during `darwin-rebuild switch`

## Mail.app Usage Tips

### Managing Multiple Accounts

**Unified Inbox**:
- Mail.app shows all accounts in one view by default
- Use sidebar to view individual account folders

**Composing from Specific Account**:
1. Click **New Message** (Cmd+N)
2. Use **From:** dropdown to select account
3. Default account: Set in **Mail > Preferences > Composing > Send new messages from**

**Organizing with Folders**:
- Gmail: Uses labels (auto-synced via IMAP)
- Gandi: Create folders with right-click → New Mailbox

### Keyboard Shortcuts

| Action | Shortcut |
|--------|----------|
| New Message | `Cmd+N` |
| Reply | `Cmd+R` |
| Reply All | `Cmd+Shift+R` |
| Forward | `Cmd+Shift+F` |
| Delete | `Cmd+Delete` |
| Archive | `Cmd+Ctrl+A` |
| Mark as Read | `Cmd+Shift+L` |
| Mark as Unread | `Cmd+Shift+U` |
| Search | `Cmd+Option+F` |
| Next Message | `Cmd+]` |
| Previous Message | `Cmd+[` |

### Preferences to Configure

**Mail > Preferences > General**:
- ✅ Check for new messages: Every 5 minutes (or as desired)
- ✅ Downloads folder: ~/Downloads
- ✅ Remove unedited downloads: After Message is Deleted

**Mail > Preferences > Accounts**:
- ✅ Verify all 5 accounts are listed
- ✅ Check "Enable this account" for each
- ✅ Set mailbox behaviors (Drafts, Sent, Junk, Trash)

**Mail > Preferences > Junk Mail**:
- ✅ Enable junk mail filtering
- ✅ Move junk to Junk mailbox (not Trash)
- ⚠️ Gmail: Use Gmail's web filters (more effective than Mail.app)

**Mail > Preferences > Composing**:
- ✅ Message Format: Rich Text or Plain Text (your preference)
- ✅ Send new messages from: Select default account
- ✅ Reply using same account: Enabled

## Troubleshooting

### Problem: Accounts Not Appearing After darwin-rebuild

**Symptoms**: Mail.app doesn't show any accounts after rebuild
**Cause**: Configuration profile not installed
**Solution**:
1. Check if profile exists: `ls -la /tmp/email-accounts.mobileconfig`
2. Open System Preferences → Profiles
3. Manually install "FX Email Accounts" profile
4. Restart Mail.app

### Problem: Gmail Authentication Fails

**Symptoms**: "Cannot verify account" or "Invalid credentials"
**Causes**:
1. OAuth redirect blocked
2. Less Secure Apps disabled
3. 2FA not configured

**Solutions**:
1. **Use App-Specific Password** (recommended):
   - Visit https://myaccount.google.com/apppasswords
   - Generate new password for Mail
   - Use 16-character password in Mail.app
2. **Enable 2FA** if not already enabled
3. **Check Google Account Activity**:
   - Visit https://myaccount.google.com/notifications
   - Approve Mail.app access if blocked

### Problem: Gandi Account Shows "Cannot Connect"

**Symptoms**: IMAP/SMTP connection fails
**Causes**:
1. Incorrect password
2. Firewall blocking ports 993/587
3. Gandi mailbox not activated

**Solutions**:
1. **Verify password**: Try logging in at https://mail.gandi.net/
2. **Check mailbox status**:
   - Log in to Gandi.net admin panel
   - Navigate to Email → Mailboxes
   - Verify mailbox is "Active"
3. **Test connection manually**:
   ```bash
   # Test IMAP (port 993)
   openssl s_client -connect mail.gandi.net:993 -crlf

   # Test SMTP (port 587)
   openssl s_client -connect mail.gandi.net:587 -starttls smtp
   ```

### Problem: Emails Not Syncing Across Devices

**Symptoms**: Emails on Mac don't appear on iPhone/iPad
**Cause**: IMAP not syncing properly
**Solution**:
1. **Check IMAP folders**:
   - Mail > Preferences > Accounts → [Account] → Mailbox Behaviors
   - Verify "Store sent messages on server" is enabled
   - Verify "Store junk messages on server" is enabled
2. **Force sync**:
   - Mailbox → Synchronize All Accounts (Cmd+Ctrl+Shift+K)
3. **Rebuild mailbox**:
   - Right-click account → Rebuild

### Problem: Cannot Send Emails (SMTP Errors)

**Symptoms**: "Cannot send message" or "SMTP server not responding"
**Causes**:
1. SMTP authentication failed
2. Port 587 blocked by firewall/VPN
3. Outgoing mail server settings incorrect

**Solutions**:
1. **Re-enter SMTP password**:
   - Mail > Preferences > Accounts → [Account] → Server Settings
   - Outgoing Mail Server → Edit Server List
   - Re-enter password
2. **Verify SMTP settings**:
   - Gmail: smtp.gmail.com, port 587, TLS
   - Gandi: mail.gandi.net, port 587, TLS
3. **Test with VPN disabled** (some VPNs block SMTP)

### Problem: Profile Shows "Not Signed" Warning

**Symptoms**: macOS warns profile is not signed
**Cause**: Profile generated locally, not from MDM server
**Solution**: This is expected and safe. The profile only contains email settings (no executables or scripts). Click "Install" to proceed.

## Advanced Configuration

### Changing Email Addresses

If you need to change any email addresses after installation:

1. **Edit email-config.nix** directly:
   ```bash
   nano ~/Documents/nix-install/email-config.nix
   ```
2. **Run darwin-rebuild**:
   ```bash
   darwin-rebuild switch --flake ~/Documents/nix-install#standard
   # OR
   darwin-rebuild switch --flake ~/Documents/nix-install#power
   ```
3. **Reinstall profile**:
   - System Preferences → Profiles
   - Remove old "FX Email Accounts" profile
   - Install new profile from `/tmp/email-accounts.mobileconfig`
4. **Open Mail.app** and enter credentials for new accounts

### Removing Email Accounts

To remove email accounts from Mail.app:

1. **System Preferences → Profiles**
2. Select "FX Email Accounts" profile
3. Click **Remove** (minus button)
4. Confirm removal
5. Open Mail.app → Accounts will be removed automatically

**Note**: This only removes Mail.app configuration, not the actual email accounts from Gmail/Gandi servers.

### Using with Other Email Clients

If you prefer Thunderbird, Outlook, or other email clients instead of Mail.app:

- Configuration profile only affects Mail.app (client-specific)
- Other clients need manual account setup
- Use same server settings:
  - **Gmail**: imap.gmail.com (993), smtp.gmail.com (587)
  - **Gandi**: mail.gandi.net (993/587)

## Security & Privacy

### Data Stored in Configuration

**In Git (Public)**:
- ✅ Template file with placeholders
- ✅ Nix module (darwin/email-accounts.nix)
- ❌ NO email addresses
- ❌ NO passwords

**On Local Disk (Private)**:
- ✅ Real email addresses (email-config.nix, gitignored)
- ❌ NO passwords (entered manually each time)
- ✅ Configuration profile (.mobileconfig, contains addresses but no passwords)

**In macOS Keychain**:
- ✅ Passwords stored securely by Mail.app
- ✅ Encrypted with macOS keychain
- ✅ Accessible only with macOS login password or Touch ID

### Best Practices

1. **Use App-Specific Passwords** for Gmail (not your main password)
2. **Enable 2FA** on all accounts (Gmail, Gandi)
3. **Backup macOS Keychain** (contains saved passwords)
4. **Never share email-config.nix** (contains real email addresses)
5. **Keep macOS updated** for security patches

## Verification Checklist

After completing setup, verify:

- [ ] All 5 accounts appear in Mail.app sidebar
- [ ] Gmail account can receive email (send test from another device)
- [ ] Gmail account can send email (send to yourself)
- [ ] Gandi account 1-4 can receive email
- [ ] Gandi account 1-4 can send email
- [ ] Emails sync across devices (Mac, iPhone, iPad)
- [ ] IMAP folders sync correctly (Sent, Drafts, Trash)
- [ ] Junk mail filtering works
- [ ] Search works across all accounts
- [ ] Attachments download correctly
- [ ] Compose from correct account works (From: dropdown)

## Related Documentation

- **Licensed Apps Guide**: See main [docs/licensed-apps.md](../../licensed-apps.md) for app activation workflows
- **Bootstrap Documentation**: [docs/REQUIREMENTS.md](../../REQUIREMENTS.md) for full bootstrap process
- **Productivity Apps**: Other apps in [docs/apps/productivity/](./README.md)

## References

- **macOS Mail.app**: Built-in macOS application (no separate installation required)
- **Gmail IMAP Settings**: https://support.google.com/mail/answer/7126229
- **Gmail App Passwords**: https://myaccount.google.com/apppasswords
- **Gandi Email Documentation**: https://docs.gandi.net/en/gandimail/
- **Configuration Profiles**: https://support.apple.com/guide/mdm/profiles-mdm6b03da9a/web

---

**Story**: 02.10-001 (5 points)
**Epic**: Epic-02 (Application Installation)
**Implementation**: Bootstrap Phase 2 (email prompts) + darwin-rebuild (profile generation)
**Manual Steps**: Profile installation + credential entry
**Security**: Email addresses gitignored, passwords never stored in config
